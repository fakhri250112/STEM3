<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Sunnah Lifestyle ‚Äî Healthy & Sustainable</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet for map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- Custom styles -->
    <style>
        body {
            font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            background: linear-gradient(135deg, #0f172a, #0ea5a2 60%);
            color: #e6eef0;
            min-height: 100vh;
        }

        .glass {
            background: rgba(255, 255, 255, 0.04);
            backdrop-filter: blur(8px);
            border-radius: 16px;
            box-shadow: 0 6px 20px rgba(2, 6, 23, 0.6);
        }

        .mini {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 0.75rem;
        }

        .small-muted {
            color: rgba(230, 238, 240, 0.7);
            font-size: 0.9rem;
        }

        #map {
            height: 320px;
            border-radius: 12px;
        }

        .pill {
            background: rgba(255, 255, 255, 0.06);
            padding: .25rem .6rem;
            border-radius: 999px;
            font-weight: 600;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: #1e293b;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 90%;
            width: 350px;
        }
    </style>
</head>
<body class="py-8 px-4">

    <main class="max-w-3xl mx-auto">
        <header class="text-center mb-6">
            <div class="inline-block p-3 glass">
                <img src="https://cdn.pixabay.com/photo/2023/11/30/10/45/allah-8421334_1280.png" alt="icon"
                    class="w-20 h-20 mx-auto rounded-full bg-white p-2" />
                <h1 class="text-2xl font-extrabold mt-2">Sunnah Lifestyle</h1>
                <p class="small-muted">Healthy habits ‚Ä¢ Prayer reminders ‚Ä¢ Sustainable living</p>
                <div id="userIdDisplay" class="mt-2 text-xs font-mono break-all opacity-50">User ID: N/A</div>
            </div>
        </header>

        <!-- Dashboard grid -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">

            <!-- Time + Prayer -->
            <div class="glass p-5">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="text-lg font-bold">Current Time</h2>
                        <div id="currentTime" class="text-2xl mt-1 font-semibold">--:--:--</div>
                        <div id="locationDisplay" class="small-muted mt-1">Detecting location...</div>
                    </div>
                    <div class="text-right">
                        <button id="enableNotifBtn"
                            class="mt-2 px-3 py-2 bg-emerald-400 text-black rounded-md font-semibold">Enable
                            Notifications</button>
                        <div id="ttsToggleWrap" class="mt-2 small-muted">TTS: <span id="ttsStatus">on</span></div>
                    </div>
                </div>

                <hr class="my-3 border-white/10" />
                <h3 class="font-semibold">Next Prayer</h3>
                <div id="nextPrayer" class="mt-2 text-lg">Loading...</div>
                <div id="prayerCountdown" class="small-muted mt-1">‚Äî</div>
                <ul id="prayerList" class="mt-3 space-y-1 small-muted"></ul>
            </div>

            <!-- Meals + countdown -->
            <div class="glass p-5">
                <h3 class="text-lg font-bold">Meals (fixed per day)</h3>
                <p class="small-muted">Menu is fixed for the day ‚Äî will update next day automatically.</p>
                <div class="mt-3 space-y-2">
                    <div class="mini">
                        <div class="flex justify-between items-center">
                            <div><b>Breakfast</b>
                                <div class="small-muted">07:00</div>
                            </div>
                            <div class="text-right">
                                <div id="breakfastCountdown" class="font-medium">‚Äî</div>
                                <div id="breakfastMenu" class="small-muted">Loading menu...</div>
                            </div>
                        </div>
                    </div>

                    <div class="mini">
                        <div class="flex justify-between items-center">
                            <div><b>Lunch</b>
                                <div class="small-muted">12:00</div>
                            </div>
                            <div class="text-right">
                                <div id="lunchCountdown" class="font-medium">‚Äî</div>
                                <div id="lunchMenu" class="small-muted">Loading menu...</div>
                            </div>
                        </div>
                    </div>

                    <div class="mini">
                        <div class="flex justify-between items-center">
                            <div><b>Dinner</b>
                                <div class="small-muted">19:00</div>
                            </div>
                            <div class="text-right">
                                <div id="dinnerCountdown" class="font-medium">‚Äî</div>
                                <div id="dinnerMenu" class="small-muted">Loading menu...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Exercise -->
            <div class="glass p-5">
                <h3 class="text-lg font-bold">Exercise Schedule</h3>
                <div class="small-muted">Daily routine</div>
                <ul class="mt-3 space-y-2">
                    <li class="mini flex justify-between items-center">
                        <div>
                            <b>Morning Stretch</b>
                            <div class="small-muted">06:30</div>
                        </div>
                        <div class="text-right">
                            <div id="stretchCountdown">‚Äî</div>
                        </div>
                    </li>

                    <li class="mini flex justify-between items-center">
                        <div>
                            <b>Cardio (Jog / Skipping)</b>
                            <div class="small-muted">16:30</div>
                        </div>
                        <div class="text-right">
                            <div id="cardioCountdown">‚Äî</div>
                        </div>
                    </li>

                    <li class="mini flex justify-between items-center">
                        <div>
                            <b>Light Workout</b>
                            <div class="small-muted">20:30</div>
                        </div>
                        <div class="text-right">
                            <div id="workoutCountdown">‚Äî</div>
                        </div>
                    </li>
                </ul>
            </div>

            <!-- Sleep + Fast toggle -->
            <div class="glass p-5">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-bold">Sleep</h3>
                    <div class="pill">22:00</div>
                </div>
                <div class="mt-3 small-muted">Recommended sleep start</div>
                <div class="mt-3">
                    <div id="sleepCountdown" class="font-medium">‚Äî</div>
                </div>

                <hr class="my-3 border-white/8" />

                <div class="flex items-center gap-2">
                    <input type="checkbox" id="fastingMode" />
                    <label for="fastingMode" class="small-muted">Ramadan Mode (auto) / Imsak & Iftar</label>
                </div>
                <div class="flex items-center gap-2 mt-2">
                    <input type="checkbox" id="sunnahMonThu" checked />
                    <label for="sunnahMonThu" class="small-muted">Sunnah Mon & Thu fasting reminders</label>
                </div>

                <div class="mt-3 small-muted" id="fastingStatus">Fasting: Off</div>
                <div class="mt-2" id="fastingCountdown">‚Äî</div>
            </div>

        </section>

        <!-- Map + Activity -->
        <section class="glass p-5 mb-4">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-bold">Activity Tracker (Strava-like)</h3>
                <div class="small-muted">GPS-based route & stats</div>
            </div>

            <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3">
                <div id="map" class="md:col-span-2"></div>
                <div class="space-y-2">
                    <div class="mini">
                        <div class="small-muted">Status</div>
                        <div id="trackStatus">Idle</div>
                    </div>
                    <div class="mini">
                        <div class="small-muted">Distance</div>
                        <div id="trackDistance">0.00 km</div>
                    </div>
                    <div class="mini">
                        <div class="small-muted">Elapsed</div>
                        <div id="trackElapsed">00:00:00</div>
                    </div>

                    <div class="mt-2 space-y-1">
                        <button id="startTrack"
                            class="w-full bg-emerald-400 text-black py-2 rounded-md font-semibold">Start</button>
                        <button id="pauseTrack"
                            class="w-full bg-yellow-400 text-black py-2 rounded-md font-semibold">Pause</button>
                        <button id="stopTrack" class="w-full bg-red-500 text-white py-2 rounded-md font-semibold">Stop
                            & Save</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Trash & Eco-challenge -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="glass p-5">
                <h3 class="text-lg font-bold">‚ôªÔ∏è Trash Tracker</h3>
                <div class="small-muted">Log daily trash (grams)</div>

                <div class="mt-3 space-y-2">
                    <input id="trashType" placeholder="Type (Plastic / Organic)"
                        class="w-full p-2 rounded bg-white/5" />
                    <input id="trashWeight" placeholder="Weight (grams)" type="number"
                        class="w-full p-2 rounded bg-white/5" />
                    <div class="flex gap-2">
                        <button id="addTrashBtn"
                            class="flex-1 bg-emerald-400 text-black py-2 rounded-md font-semibold">Add</button>
                        <button id="clearTrashBtn" class="bg-white/6 text-white py-2 px-3 rounded-md">Clear</button>
                    </div>
                    <div class="mt-3 small-muted">Today's log</div>
                    <ul id="trashList" class="mt-2 small-muted space-y-1 max-h-40 overflow-auto"></ul>
                    <div class="mt-2 font-semibold" id="trashTotal">Total: 0 g</div>
                </div>
            </div>

            <div class="glass p-5">
                <h3 class="text-lg font-bold">üå± Eco-Challenges</h3>
                <div class="small-muted">Complete tasks to earn eco points</div>
                <ul class="mt-3 space-y-2" id="challengeList"></ul>
                <div class="mt-3 small-muted">Points: <span id="ecoPoints">0</span></div>
            </div>
        </section>
        
        <!-- History Section -->
        <section class="glass p-5 mb-6">
            <div id="historyHeader" class="flex justify-between items-center cursor-pointer">
                <h3 class="text-lg font-bold">üìú Riwayat Harian</h3>
                <span id="historyToggleIcon" class="text-2xl transition-transform duration-300">‚ñº</span>
            </div>
            <div id="historyContent" class="hidden mt-4">
                <div id="historyLoading" class="text-center small-muted">Memuat riwayat...</div>
                <ul id="historyList" class="mt-2 space-y-4"></ul>
                <div id="noHistoryMessage" class="hidden text-center small-muted">Tidak ada riwayat untuk ditampilkan.</div>
            </div>
        </section>

        <footer class="text-center small-muted">App Developed by Fakhri - Project Developed by Group 3</footer>
    </main>

    <!-- Custom Modal UI -->
    <div id="appModal" class="modal-overlay">
        <div class="modal-content">
            <p id="modalMessage" class="text-lg font-semibold mb-4"></p>
            <div id="modalButtons" class="flex justify-center gap-4">
                <!-- Buttons will be inserted here by JS -->
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, addDoc, collection, query, where, getDocs, onSnapshot, getDoc, setLogLevel, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Global variables provided by the canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let auth, db, userId;

        /* =========================
         * Initialization & Helpers
         * ========================= */

        const nowEl = document.getElementById('currentTime');
        const locationDisplay = document.getElementById('locationDisplay');
        const enableNotifBtn = document.getElementById('enableNotifBtn');
        const ttsStatusEl = document.getElementById('ttsStatus');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const appModal = document.getElementById('appModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalButtons = document.getElementById('modalButtons');
        const historyHeader = document.getElementById('historyHeader');
        const historyContent = document.getElementById('historyContent');
        const historyToggleIcon = document.getElementById('historyToggleIcon');
        const historyList = document.getElementById('historyList');
        const noHistoryMessage = document.getElementById('noHistoryMessage');

        let notificationsEnabled = false;
        let ttsEnabled = true; // use speechSynthesis for voice reminders
        let userCoords = null;
        let firestoreListeners = [];

        // Custom modal for alerts/confirms
        function showModal(message, options) {
            return new Promise((resolve) => {
                modalMessage.textContent = message;
                modalButtons.innerHTML = '';
                options.forEach(option => {
                    const button = document.createElement('button');
                    button.textContent = option.text;
                    button.className = option.className;
                    button.onclick = () => {
                        appModal.classList.remove('open');
                        resolve(option.value);
                    };
                    modalButtons.appendChild(button);
                });
                appModal.classList.add('open');
            });
        }

        // speech helper
        function speak(text) {
            if (!ttsEnabled) return;
            try {
                const u = new SpeechSynthesisUtterance(text);
                const voices = speechSynthesis.getVoices();
                if (voices && voices.length) {
                    const prefer = voices.find(v => /female|Google UK English|en-GB|en-US/i.test(v.name));
                    if (prefer) u.voice = prefer;
                }
                u.rate = 1;
                speechSynthesis.cancel();
                speechSynthesis.speak(u);
            } catch (e) {
                console.warn('TTS error', e);
            }
        }

        // notification helper
        async function showNotification(title, body) {
            if (!notificationsEnabled) return;
            try {
                new Notification(title, { body });
            } catch (e) {
                console.warn('Notification show error', e);
            }
        }

        // request notification permission
        enableNotifBtn.addEventListener('click', async () => {
            if (!('Notification' in window)) {
                showModal('This browser does not support notifications.', [{ text: 'OK', className: 'bg-emerald-400 text-black py-2 px-4 rounded-md font-semibold', value: true }]);
                return;
            }
            const p = await Notification.requestPermission();
            notificationsEnabled = (p === 'granted');
            enableNotifBtn.textContent = notificationsEnabled ? 'Notifications Enabled' : 'Enable Notifications';
        });

        // current time update
        function pad(n) {
            return n.toString().padStart(2, '0');
        }

        function updateClock() {
            const d = new Date();
            nowEl.textContent = d.toLocaleTimeString();
        }
        setInterval(updateClock, 1000);
        updateClock();

        /* =========================
         * Firebase Initialization
         * ========================= */

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        setLogLevel('debug');
        auth = getAuth(app);

        async function initAuthAndDataListeners() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth Error: ", error);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = `User ID: ${userId}`;
                    console.log('User signed in with UID:', userId);
                    attachFirestoreListeners();
                } else {
                    console.log("No user is signed in.");
                    userId = null;
                }
            });
        }

        function attachFirestoreListeners() {
            if (!userId) {
                console.warn("User ID not available, cannot attach listeners.");
                return;
            }

            const userDocDataRef = doc(db, 'artifacts', appId, 'users', userId, 'data', 'lifestyle');
            const trashCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'trash');
            const runsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'runs');
            const dailyLogsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'dailyLogs');

            // Listen for changes in eco points and challenges
            firestoreListeners.push(onSnapshot(userDocDataRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    ecoPoints = data.ecoPoints || 0;
                    renderChallenges(data.chDone || {});
                } else {
                    setDoc(userDocDataRef, { ecoPoints: 0, chDone: {} });
                }
            }, (error) => {
                console.error("Error listening to user data:", error);
            }));

            // Listen for changes in trash log
            firestoreListeners.push(onSnapshot(trashCollectionRef, (querySnapshot) => {
                const logs = [];
                querySnapshot.forEach(doc => {
                    logs.push({ id: doc.id, ...doc.data() });
                });
                trashLog = logs;
                renderTrash();
            }, (error) => {
                console.error("Error listening to trash log:", error);
            }));
            
            // Listen for changes in daily logs for history
            firestoreListeners.push(onSnapshot(dailyLogsCollectionRef, (querySnapshot) => {
                const dailyLogs = [];
                querySnapshot.forEach(doc => {
                    dailyLogs.push({ id: doc.id, ...doc.data() });
                });
                renderHistory(dailyLogs);
            }, (error) => {
                console.error("Error listening to daily logs:", error);
            }));
        }

        /* =========================
         * Prayer times (Aladhan)
         * ========================= */

        let prayerTimings = {}; // will hold times as "HH:MM"
        let hijriInfo = null;

        async function fetchPrayerTimes(lat, lon) {
            try {
                const timestamp = Math.floor(Date.now() / 1000);
                const url = `https://api.aladhan.com/v1/timings/${timestamp}?latitude=${lat}&longitude=${lon}&method=2`;
                const res = await fetch(url);
                const data = await res.json();
                if (data && data.data && data.data.timings) {
                    prayerTimings = data.data.timings;
                    hijriInfo = data.data.date && data.data.date.hijri ? data.data.date.hijri : null;
                    renderPrayerList();
                    evaluateFastingMode();
                } else {
                    throw new Error('Invalid API data');
                }
            } catch (e) {
                console.warn('Aladhan fetch failed, fallback to defaults', e);
                prayerTimings = {
                    Fajr: '05:00',
                    Dhuhr: '12:00',
                    Asr: '15:00',
                    Maghrib: '18:00',
                    Isha: '20:00'
                };
                renderPrayerList();
            }
        }

        function renderPrayerList() {
            const list = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
            const ul = document.getElementById('prayerList');
            ul.innerHTML = list.map(p => `<li><b>${p}</b>: ${prayerTimings[p] || '‚Äî'}</li>`).join('');
            document.getElementById('nextPrayer').textContent = computeNextPrayerText();
        }

        function timeToTodayDate(hhmm) {
            const [hh, mm] = (hhmm || '00:00').split(':').map(Number);
            const d = new Date();
            d.setHours(hh, mm, 0, 0);
            return d;
        }

        function computeNextPrayerText() {
            const now = new Date();
            const order = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
            for (const p of order) {
                if (prayerTimings[p]) {
                    const t = timeToTodayDate(prayerTimings[p]);
                    if (t > now) return `${p} ${prayerTimings[p]}`;
                }
            }
            const t = prayerTimings['Fajr'] ? prayerTimings['Fajr'] : '05:00';
            return `Fajr ${t} (tomorrow)`;
        }

        /* =========================
         * Meals (fixed per day)
         * ========================= */

        const todayKey = () => {
            const d = new Date();
            return `menus-${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`;
        };

        const defaultMenus = {
            breakfast: "Dates & milk ‚Äî Prophet‚Äôs breakfast",
            lunch: "Brown rice & grilled chicken ‚Äî balanced",
            dinner: "Light vegetable soup & fruit ‚Äî easy digestion"
        };

        function loadMenusForToday() {
            let menus = JSON.parse(localStorage.getItem(todayKey()) || 'null');
            if (!menus) {
                menus = { ...defaultMenus
                };
                localStorage.setItem(todayKey(), JSON.stringify(menus));
            }
            document.getElementById('breakfastMenu').textContent = menus.breakfast;
            document.getElementById('lunchMenu').textContent = menus.lunch;
            document.getElementById('dinnerMenu').textContent = menus.dinner;
        }
        loadMenusForToday();

        /* =========================
         * Scheduler for reminders
         * ========================= */

        let scheduledEvents = []; // {id, name, date:Date, category, data}
        let triggeredIds = new Set();

        function scheduleEvent(id, name, date, category, data = {}) {
            if (!date || isNaN(date.getTime())) return;
            scheduledEvents.push({
                id,
                name,
                date,
                category,
                data
            });
        }

        function buildDailySchedule() {
            scheduledEvents = [];
            triggeredIds = new Set();
            const now = new Date();

            ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'].forEach(p => {
                if (prayerTimings[p]) {
                    const d = timeToTodayDate(prayerTimings[p]);
                    scheduleEvent(`prayer-${p}`, `Prayer: ${p}`, d, 'prayer', {
                        prayer: p
                    });
                }
            });

            const breakfast = timeToTodayDate('07:00');
            const lunch = timeToTodayDate('12:00');
            const dinner = timeToTodayDate('19:00');
            scheduleEvent('meal-breakfast', 'Breakfast', breakfast, 'meal', {
                menu: document.getElementById('breakfastMenu').textContent,
                meal: 'Breakfast'
            });
            scheduleEvent('meal-lunch', 'Lunch', lunch, 'meal', {
                menu: document.getElementById('lunchMenu').textContent,
                meal: 'Lunch'
            });
            scheduleEvent('meal-dinner', 'Dinner', dinner, 'meal', {
                menu: document.getElementById('dinnerMenu').textContent,
                meal: 'Dinner'
            });

            scheduleEvent('ex-stretch', 'Morning Stretch', timeToTodayDate('06:30'), 'exercise', {});
            scheduleEvent('ex-cardio', 'Cardio', timeToTodayDate('16:30'), 'exercise', {});
            scheduleEvent('ex-workout', 'Light Workout', timeToTodayDate('20:30'), 'exercise', {});
            scheduleEvent('sleep', 'Sleep time', timeToTodayDate('22:00'), 'sleep', {});

            evaluateFastingMode();

            scheduledEvents.sort((a, b) => a.date - b.date);
        }

        function evaluateFastingMode() {
            const fastingToggle = document.getElementById('fastingMode');
            let ramadanDetected = false;
            if (hijriInfo && hijriInfo.month && hijriInfo.month.number) {
                ramadanDetected = (hijriInfo.month.number === 9);
            }
            if (ramadanDetected) {
                fastingToggle.checked = true;
            }
            const sunnahToggle = document.getElementById('sunnahMonThu');
            const today = new Date();
            const weekday = today.getDay();
            const fastOn = fastingToggle.checked;
            const sunnahOn = sunnahToggle.checked && (weekday === 1 || weekday === 4);
            const fastingStatusEl = document.getElementById('fastingStatus');
            fastingStatusEl.textContent = fastOn ? 'Fasting Mode: On (Ramadan or manual)' : 'Fasting Mode: Off';

            scheduledEvents = scheduledEvents.filter(e => !e.id.startsWith('fast-'));
            if (fastOn || sunnahOn || ramadanDetected) {
                if (prayerTimings['Fajr']) {
                    const fajrDate = timeToTodayDate(prayerTimings['Fajr']);
                    const imsakDate = new Date(fajrDate.getTime() - 10 * 60000);
                    scheduleEvent('fast-imsak', 'Imsak (stop eating)', imsakDate, 'fast', {
                        type: 'imsak'
                    });
                }
                if (prayerTimings['Maghrib']) {
                    const maghribDate = timeToTodayDate(prayerTimings['Maghrib']);
                    scheduleEvent('fast-iftar', 'Iftar (break fast)', maghribDate, 'fast', {
                        type: 'iftar'
                    });
                }
            }
        }

        /* =========================
         * Countdown UI & trigger loop
         * ========================= */

        function msToHMS(ms) {
            if (ms < 0) ms = 0;
            const s = Math.floor(ms / 1000) % 60;
            const m = Math.floor(ms / 60000) % 60;
            const h = Math.floor(ms / 3600000);
            return `${pad(h)}:${pad(m)}:${pad(s)}`;
        }

        function msToFriendly(ms) {
            if (ms <= 0) return 'Now';
            const s = Math.floor(ms / 1000) % 60;
            const m = Math.floor(ms / 60000) % 60;
            const h = Math.floor(ms / 3600000);
            if (h > 0) return `${h}h ${m}m ${s}s`;
            if (m > 0) return `${m}m ${s}s`;
            return `${s}s`;
        }

        function updateCountdowns() {
            const now = new Date();

            const nextPrayerEvent = scheduledEvents.find(e => e.category === 'prayer' && e.date > now);
            if (nextPrayerEvent) {
                const ms = nextPrayerEvent.date - now;
                document.getElementById('prayerCountdown').textContent = `Next: ${nextPrayerEvent.name} ‚Äî ${msToFriendly(ms)}`;
            } else {
                document.getElementById('prayerCountdown').textContent = 'No more prayers today';
            }

            const breakfastEvent = scheduledEvents.find(e => e.id === 'meal-breakfast');
            const lunchEvent = scheduledEvents.find(e => e.id === 'meal-lunch');
            const dinnerEvent = scheduledEvents.find(e => e.id === 'meal-dinner');
            document.getElementById('breakfastCountdown').textContent = breakfastEvent ? msToFriendly(breakfastEvent.date - now) : '‚Äî';
            document.getElementById('lunchCountdown').textContent = lunchEvent ? msToFriendly(lunchEvent.date - now) : '‚Äî';
            document.getElementById('dinnerCountdown').textContent = dinnerEvent ? msToFriendly(dinnerEvent.date - now) : '‚Äî';

            ['ex-stretch', 'ex-cardio', 'ex-workout'].forEach(id => {
                const ev = scheduledEvents.find(e => e.id === id);
                const el = id === 'ex-stretch' ? 'stretchCountdown' : id === 'ex-cardio' ? 'cardioCountdown' : 'workoutCountdown';
                document.getElementById(el).textContent = ev ? msToFriendly(ev.date - now) : '‚Äî';
            });

            const sleepEv = scheduledEvents.find(e => e.id === 'sleep');
            document.getElementById('sleepCountdown').textContent = sleepEv ? msToFriendly(sleepEv.date - now) : '‚Äî';

            const fastEv = scheduledEvents.find(e => e.category === 'fast' && e.date > now);
            if (fastEv) {
                document.getElementById('fastingCountdown').textContent = `${fastEv.name} in ${msToFriendly(fastEv.date - now)}`;
            } else {
                document.getElementById('fastingCountdown').textContent = 'No fasting reminders today';
            }

            scheduledEvents.forEach(ev => {
                const remaining = ev.date - now;
                if (remaining <= 0 && !triggeredIds.has(ev.id)) {
                    triggeredIds.add(ev.id);
                    handleEventTrigger(ev);
                }
            });
        }
        setInterval(updateCountdowns, 1000);

        /* =========================
         * Event trigger action
         * ========================= */

        function handleEventTrigger(ev) {
            switch (ev.category) {
                case 'prayer':
                    speak(`It is time for ${ev.data.prayer} prayer.`);
                    showNotification('Prayer Reminder', `Time for ${ev.data.prayer} prayer`);
                    break;
                case 'meal':
                    speak(`Time for ${ev.data.meal}. Today's menu is: ${ev.data.menu}`);
                    showNotification('Meal Reminder', `Time for ${ev.data.meal}`);
                    break;
                case 'exercise':
                    speak(`Time to exercise. ${ev.name}`);
                    showNotification('Exercise Reminder', ev.name);
                    break;
                case 'sleep':
                    speak(`Time to sleep. Good night.`);
                    showNotification('Sleep Reminder', 'Time to sleep');
                    break;
                case 'fast':
                    if (ev.data.type === 'imsak') {
                        speak(`Imsak. Stop eating now.`);
                        showNotification('Imsak', 'Stop eating now');
                    } else if (ev.data.type === 'iftar') {
                        speak(`Alhamdulillah. It is time to break your fast.`);
                        showNotification('Iftar', 'Time to break your fast');
                    }
                    break;
            }
        }

        /* =========================
         * Periodic rebuild schedule
         * ========================= */

        function rebuildScheduleAndUI() {
            buildDailySchedule();
            updateCountdowns();
        }
        setInterval(() => {
            rebuildScheduleAndUI();
        }, 5 * 60 * 1000);

        /* =========================
         * Location detection & Aladhan init
         * ========================= */

        function initLocationAndPrayer() {
            if (!navigator.geolocation) {
                locationDisplay.textContent = 'Geolocation not supported. Using Jakarta fallback.';
                userCoords = {
                    lat: -6.2088,
                    lon: 106.8456
                };
                fetchPrayerTimes(userCoords.lat, userCoords.lon).then(() => {
                    buildDailySchedule();
                });
                return;
            }
            navigator.geolocation.getCurrentPosition(pos => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                userCoords = {
                    lat,
                    lon
                };
                locationDisplay.textContent = `Location: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                fetchPrayerTimes(lat, lon).then(() => {
                    buildDailySchedule();
                });
            }, err => {
                console.warn('Location denied or error', err);
                locationDisplay.textContent = 'Location denied. Using Jakarta fallback.';
                userCoords = {
                    lat: -6.2088,
                    lon: 106.8456
                };
                fetchPrayerTimes(userCoords.lat, userCoords.lon).then(() => {
                    buildDailySchedule();
                });
            }, {
                enableHighAccuracy: true,
                timeout: 8000
            });
        }
        initLocationAndPrayer();

        /* =========================
         * GPS Tracking (Leaflet)
         * ========================= */

        let map, polyline, watchIdTrack = null,
            tracking = false;
        let trackCoords = [],
            trackStart = null,
            trackElapsedInterval = null,
            trackDist = 0;

        function initMap() {
            map = L.map('map', {
                zoomControl: false
            }).setView([userCoords ? userCoords.lat : 0, userCoords ? userCoords.lon : 0], userCoords ? 14 : 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);
            polyline = L.polyline([], {
                color: '#06b6d4'
            }).addTo(map);
        }
        initMap();

        function haversineDist(a, b) {
            const R = 6371e3;
            const œÜ1 = a.lat * Math.PI / 180,
                œÜ2 = b.lat * Math.PI / 180;
            const ŒîœÜ = (b.lat - a.lat) * Math.PI / 180;
            const ŒîŒª = (b.lon - a.lon) * Math.PI / 180;
            const aa = Math.sin(ŒîœÜ / 2) ** 2 + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(aa), Math.sqrt(1 - aa));
            return R * c; // meters
        }

        function startTracking() {
            if (!navigator.geolocation) return showModal('Geolocation not supported.', [{ text: 'OK', className: 'bg-emerald-400 text-black py-2 px-4 rounded-md font-semibold', value: true }]);
            if (tracking) return;
            trackCoords = [];
            trackDist = 0;
            trackStart = new Date();
            document.getElementById('trackStatus').textContent = 'Tracking...';
            tracking = true;
            polyline.setLatLngs([]);
            watchIdTrack = navigator.geolocation.watchPosition(p => {
                const lat = p.coords.latitude,
                    lon = p.coords.longitude;
                const point = {
                    lat,
                    lon,
                    ts: Date.now()
                };
                if (trackCoords.length > 0) {
                    const last = trackCoords[trackCoords.length - 1];
                    const d = haversineDist({
                        lat: last.lat,
                        lon: last.lon
                    }, {
                        lat,
                        lon
                    });
                    if (!isNaN(d) && d > 0) trackDist += d;
                }
                trackCoords.push(point);
                polyline.addLatLng([lat, lon]);
                map.setView([lat, lon], 15);
                document.getElementById('trackDistance').textContent = `${(trackDist / 1000).toFixed(2)} km`;
            }, err => {
                console.warn('track err', err);
            }, {
                enableHighAccuracy: true,
                maximumAge: 1000
            });
            trackElapsedInterval = setInterval(() => {
                const s = Math.floor((Date.now() - trackStart.getTime()) / 1000);
                const hh = pad(Math.floor(s / 3600));
                const mm = pad(Math.floor((s % 3600) / 60));
                const ss = pad(s % 60);
                document.getElementById('trackElapsed').textContent = `${hh}:${mm}:${ss}`;
            }, 1000);
        }

        function pauseTracking() {
            if (!tracking) return;
            if (watchIdTrack) {
                navigator.geolocation.clearWatch(watchIdTrack);
                watchIdTrack = null;
                document.getElementById('trackStatus').textContent = 'Paused';
            }
            if (trackElapsedInterval) {
                clearInterval(trackElapsedInterval);
                trackElapsedInterval = null;
            }
            tracking = false;
        }

        async function stopAndSaveTracking() {
            if (!userId) {
                 showModal('You must be signed in to save activity.', [{ text: 'OK', className: 'bg-red-500 text-white py-2 px-4 rounded-md font-semibold', value: true }]);
                 return;
            }
            if (watchIdTrack) navigator.geolocation.clearWatch(watchIdTrack);
            if (trackElapsedInterval) clearInterval(trackElapsedInterval);
            document.getElementById('trackStatus').textContent = 'Stopped';

            if (trackCoords.length > 0) {
                try {
                    const runsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'runs');
                    const newRunDoc = await addDoc(runsCollectionRef, {
                        coords: JSON.stringify(trackCoords), // serialize nested array
                        dist_m: Math.round(trackDist),
                        start: trackStart,
                        createdAt: new Date()
                    });
                    speak(`Run saved. Distance ${(trackDist / 1000).toFixed(2)} kilometers.`);
                    showModal('Activity saved!', [{ text: 'OK', className: 'bg-emerald-400 text-black py-2 px-4 rounded-md font-semibold', value: true }]);
                } catch (e) {
                    console.error("Error saving run to Firestore:", e);
                    showModal('Failed to save activity.', [{ text: 'OK', className: 'bg-red-500 text-white py-2 px-4 rounded-md font-semibold', value: true }]);
                }
            } else {
                showModal('No activity recorded.', [{ text: 'OK', className: 'bg-white/6 text-white py-2 px-4 rounded-md', value: true }]);
            }

            trackCoords = [];
            trackDist = 0;
            document.getElementById('trackDistance').textContent = '0.00 km';
            document.getElementById('trackElapsed').textContent = '00:00:00';
            tracking = false;
            watchIdTrack = null;
        }

        document.getElementById('startTrack').addEventListener('click', startTracking);
        document.getElementById('pauseTrack').addEventListener('click', pauseTracking);
        document.getElementById('stopTrack').addEventListener('click', stopAndSaveTracking);

        /* =========================
         * Trash tracker & Eco-challenges
         * ========================= */
        
        const getTodayDate = () => {
            const d = new Date();
            return `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`;
        };

        async function updateDailyLog(updates) {
            if (!userId) return;
            const todayDocRef = doc(db, 'artifacts', appId, 'users', userId, 'dailyLogs', getTodayDate());
            const todayDoc = await getDoc(todayDocRef);

            if (todayDoc.exists()) {
                const data = todayDoc.data();
                const newTotalTrash = (data.totalTrash || 0) + (updates.trash?.weight || 0);
                const newEcoPoints = (data.ecoPoints || 0) + (updates.ecoPoints || 0);
                const newTrashBreakdown = { ...data.trashBreakdown };
                if (updates.trash) {
                    newTrashBreakdown[updates.trash.type] = (newTrashBreakdown[updates.trash.type] || 0) + updates.trash.weight;
                }

                await updateDoc(todayDocRef, {
                    totalTrash: newTotalTrash,
                    ecoPoints: newEcoPoints,
                    trashBreakdown: newTrashBreakdown
                });
            } else {
                const trashBreakdown = {};
                if (updates.trash) {
                    trashBreakdown[updates.trash.type] = updates.trash.weight;
                }
                await setDoc(todayDocRef, {
                    date: new Date(),
                    totalTrash: updates.trash?.weight || 0,
                    ecoPoints: updates.ecoPoints || 0,
                    trashBreakdown: trashBreakdown
                });
            }
        }
        
        let trashLog = [];

        function renderTrash() {
            const ul = document.getElementById('trashList');
            const today = new Date().toLocaleDateString();
            const todayLog = trashLog.filter(t => t.date === today);
            ul.innerHTML = todayLog.map(t => `<li>${t.time} ‚Äî ${t.type}: ${t.weight} g</li>`).join('') || '<li class="small-muted">No entries today</li>';
            const total = todayLog.reduce((s, t) => s + t.weight, 0);
            document.getElementById('trashTotal').textContent = `Total: ${total} g`;
        }

        document.getElementById('addTrashBtn').addEventListener('click', async () => {
            if (!userId) {
                 showModal('You must be signed in to add trash logs.', [{ text: 'OK', className: 'bg-red-500 text-white py-2 px-4 rounded-md font-semibold', value: true }]);
                 return;
            }
            const type = document.getElementById('trashType').value.trim() || 'Other';
            const weight = parseInt(document.getElementById('trashWeight').value) || 0;
            if (!weight) {
                showModal('Enter weight in grams', [{ text: 'OK', className: 'bg-white/6 text-white py-2 px-4 rounded-md', value: true }]);
                return;
            }
            const now = new Date();
            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'trash'), {
                    date: now.toLocaleDateString(),
                    time: now.toLocaleTimeString(),
                    type,
                    weight
                });
                await updateDailyLog({ trash: { type, weight } });
                document.getElementById('trashType').value = '';
                document.getElementById('trashWeight').value = '';
            } catch (e) {
                console.error("Error adding trash log:", e);
                showModal('Failed to add trash log.', [{ text: 'OK', className: 'bg-red-500 text-white py-2 px-4 rounded-md font-semibold', value: true }]);
            }
        });

        document.getElementById('clearTrashBtn').addEventListener('click', async () => {
            if (!userId) {
                 showModal('You must be signed in to clear trash logs.', [{ text: 'OK', className: 'bg-red-500 text-white py-2 px-4 rounded-md font-semibold', value: true }]);
                 return;
            }
            const shouldClear = await showModal('Are you sure you want to clear all trash logs?', [
                { text: 'Yes', className: 'bg-red-500 text-white py-2 px-4 rounded-md font-semibold', value: true },
                { text: 'No', className: 'bg-white/6 text-white py-2 px-4 rounded-md ml-4', value: false }
            ]);

            if (shouldClear) {
                try {
                    const trashCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'trash');
                    const querySnapshot = await getDocs(trashCollectionRef);
                    const batch = writeBatch(db);
                    querySnapshot.forEach(docSnap => {
                        batch.delete(docSnap.ref);
                    });
                    await batch.commit();
                    trashLog = [];
                    renderTrash();
                } catch (e) {
                    console.error("Error clearing trash logs:", e);
                    showModal('Failed to clear trash logs.', [{ text: 'OK', className: 'bg-red-500 text-white py-2 px-4 rounded-md font-semibold', value: true }]);
                }
            }
        });


        /* Eco challenges */

        const challengesTemplate = [{
            id: 'c1',
            text: 'Bring your own water bottle',
            pts: 5
        }, {
            id: 'c2',
            text: 'Use a reusable bag',
            pts: 4
        }, {
            id: 'c3',
            text: 'Cycle instead of driving for 2 km',
            pts: 8
        }, {
            id: 'c4',
            text: 'Pick up 3 pieces of trash',
            pts: 6
        }, ];
        let ecoPoints = 0;

        function renderChallenges(done) {
            const ul = document.getElementById('challengeList');
            ul.innerHTML = challengesTemplate.map(c => {
                const checked = done[c.id] ? 'checked' : '';
                return `<li class="mini flex justify-between items-center"><div><input type="checkbox" data-id="${c.id}" ${checked} /> <span class="small-muted ml-2">${c.text}</span></div><div class="small-muted">${c.pts} pts</div></li>`;
            }).join('');
            document.getElementById('ecoPoints').textContent = ecoPoints;

            ul.querySelectorAll('input[type=checkbox]').forEach(cb => {
                cb.addEventListener('change', async (e) => {
                    if (!userId) {
                        e.target.checked = !e.target.checked;
                        showModal('You must be signed in to update challenges.', [{ text: 'OK', className: 'bg-red-500 text-white py-2 px-4 rounded-md font-semibold', value: true }]);
                        return;
                    }
                    const id = cb.dataset.id;
                    const conf = challengesTemplate.find(x => x.id === id);
                    const userDocDataRef = doc(db, 'artifacts', appId, 'users', userId, 'data', 'lifestyle');
                    
                    try {
                        let newEcoPoints = ecoPoints;
                        let pointChange = 0;
                        if (e.target.checked) {
                            newEcoPoints += conf.pts;
                            pointChange = conf.pts;
                        } else {
                            newEcoPoints -= conf.pts;
                            pointChange = -conf.pts;
                        }
                        await updateDoc(userDocDataRef, {
                            [`chDone.${id}`]: e.target.checked,
                            ecoPoints: newEcoPoints
                        });
                        await updateDailyLog({ ecoPoints: pointChange });
                    } catch (e) {
                        console.error("Error updating eco points:", e);
                    }
                });
            });
        }

        /* =========================
         * History logic
         * ========================= */
        
        const historyDateFormat = new Intl.DateTimeFormat('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
        
        function renderHistory(dailyLogs) {
            historyList.innerHTML = '';
            if (dailyLogs.length <= 1) { // 1 is today's log, so no history
                noHistoryMessage.classList.remove('hidden');
                return;
            }
            noHistoryMessage.classList.add('hidden');
            
            const sortedLogs = dailyLogs.sort((a, b) => b.date.toDate() - a.date.toDate());
            
            // Filter out today's log for the history view
            const historyLogs = sortedLogs.filter(log => {
                const logDate = log.date.toDate();
                const today = new Date();
                return logDate.getDate() !== today.getDate() ||
                       logDate.getMonth() !== today.getMonth() ||
                       logDate.getFullYear() !== today.getFullYear();
            });
            
            historyLoading.classList.add('hidden');
            if (historyLogs.length === 0) {
                noHistoryMessage.classList.remove('hidden');
                return;
            }

            historyLogs.forEach(log => {
                const dateString = historyDateFormat.format(log.date.toDate());
                const trashBreakdown = Object.entries(log.trashBreakdown || {}).map(([type, weight]) => `${type}: ${weight} g`).join(', ');
                const historyItem = document.createElement('li');
                historyItem.className = 'glass p-4 rounded-md';
                historyItem.innerHTML = `
                    <div class="text-sm font-semibold">${dateString}</div>
                    <div class="small-muted mt-2">
                        - Sampah: ${log.totalTrash || 0} g (${trashBreakdown || 'Tidak ada data'})
                    </div>
                    <div class="small-muted">
                        - Poin Ekologi: ${log.ecoPoints || 0} pts
                    </div>
                `;
                historyList.appendChild(historyItem);
            });
        }
        
        historyHeader.addEventListener('click', () => {
            const isHidden = historyContent.classList.toggle('hidden');
            historyToggleIcon.style.transform = isHidden ? 'rotate(0deg)' : 'rotate(180deg)';
        });


        /* =========================
         * UI Toggling & Fast Mode toggles
         * ========================= */

        document.getElementById('fastingMode').addEventListener('change', () => {
            evaluateFastingMode();
            rebuildScheduleAndUI();
        });
        document.getElementById('sunnahMonThu').addEventListener('change', () => {
            evaluateFastingMode();
            rebuildScheduleAndUI();
        });

        /* =========================
         * On first load: build schedule
         * ========================= */

        // Start Firebase auth and data listeners
        initAuthAndDataListeners();

        setTimeout(() => {
            // slight delay to allow location fetch
            buildDailySchedule();
            updateCountdowns();
        }, 1200);

        /* =========================
         * Menu fixed next-day update (midnight job)
         * ========================= */

        function midnightCheckForNewDay() {
            const now = new Date();
            const tomorrow = new Date();
            tomorrow.setHours(24, 0, 1, 0);
            const ms = tomorrow.getTime() - now.getTime();
            setTimeout(() => {
                const d = new Date();
                const key = `menus-${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`;
                const breakfastOpts = [
                    "Dates & milk ‚Äî Prophet‚Äôs breakfast",
                    "Honey & banana ‚Äî energy",
                    "Barley bread & yogurt"
                ];
                const lunchOpts = [
                    "Brown rice & grilled chicken",
                    "Quinoa & tuna salad",
                    "Whole grain bread & hummus"
                ];
                const dinnerOpts = [
                    "Light veggie soup & yogurt",
                    "Goat milk & dates",
                    "Fresh fruits & tea"
                ];
                const menus = {
                    breakfast: breakfastOpts[Math.floor(Math.random() * breakfastOpts.length)],
                    lunch: lunchOpts[Math.floor(Math.random() * lunchOpts.length)],
                    dinner: dinnerOpts[Math.floor(Math.random() * dinnerOpts.length)]
                };
                localStorage.setItem(key, JSON.stringify(menus));
                loadMenusForToday();
                buildDailySchedule();
                midnightCheckForNewDay();
            }, ms);
        }
        midnightCheckForNewDay();
    </script>
</body>
</html>
